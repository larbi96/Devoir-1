<html>
<head>
	<link rel="stylesheet" type="text/css" href="css/font-awesome.css" />
	<!-- <script src="src/RadialMenu.js"></script>-->
	<style>
		html, body {
			margin: 1em;
			padding: 1em;
			font: 15px 'Arial';
			height: 100%;
			-webkit-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}
		p {
			text-align: justify;
		}

		canvas {
			cursor: var(--cursor-state);
		}

		.btn_color{
			width:50px;
			height:50px;
			border: 3px solid black;
		}
	</style>
</head>
<body>

<script language="JavaScript">
var MODE_DRAW = 1;
var MODE_SELECT = 2;
var MODE_MOVE = 3;
var mode = MODE_DRAW;
</script>

<canvas id="myCanvas" width="500" height="600" style="border:2px solid #000000;"> </canvas>
<br/>
<label><input id="radio_draw" type='radio' name="radio_mode" onclick='setMode(MODE_DRAW);' checked>Draw</label>
<label><input id="radio_select" type='radio' name="radio_mode" onclick='setMode(MODE_SELECT);'>Rectangle Select</label>
<label><input id="radio_move" type='radio' name="radio_mode" onclick='setMode(MODE_MOVE);'>Move Selection</label>
<button onclick="clearButtonHandler()">Delete All</button>

<br/>

<script language="JavaScript">

var canvas = document.getElementById("myCanvas");
var canvas_context = canvas.getContext("2d");

var mouse_drag_start_x = 0;
var mouse_drag_start_y = 0;
var mouse_previous_x = 0;
var mouse_previous_y = 0;
var buttonIsDown = false;
//used to count the number of points in stroke and then compare it to the stroke length 

//used mesure to height and width of the rectangle
var width = 0;
var height = 0;

//used for movig the selection
var disX = 0;
var disY = 0;

// this is the set of strokes already drawn
var arrayOfStrokes = [];
// this is the set of strokes that are currently selected
var selectedStrokes = [];
// this is the stroke currently being drawn
var stroke = []; // each stroke is an array of points
//Current stroke color when drawing
var stroke_color = "#000000";

var startX = 0; 
var startY = 0;

function mouseDownHandler(e) {
	buttonIsDown = true;
	var canvas_rectangle = canvas.getBoundingClientRect();
	var event_x = e.clientX - canvas_rectangle.left;
	var event_y = e.clientY - canvas_rectangle.top;

	//console.log("mouse down");
	//console.log("   " + event_x + "," + event_y);
	stroke = [];
	switch ( mode ) {
		case MODE_DRAW :
			stroke.push( { x : event_x, y : event_y } );
			break;
		case MODE_SELECT :
		   startX = e.clientX - canvas_rectangle.left;
           startY = e.clientY - canvas_rectangle.top;
			break;
		case MODE_MOVE :
			mouse_drag_start_x  = event_x;
	    	mouse_drag_start_y = event_y;
			break;
	}
	
}

function mouseUpHandler(e) {
	buttonIsDown = false;
	var canvas_rectangle = canvas.getBoundingClientRect();
	var event_x = e.clientX - canvas_rectangle.left;
	var event_y = e.clientY - canvas_rectangle.top;
	// console.log("mouse up");

	switch ( mode ) {
		case MODE_DRAW :
			if ( stroke.length > 2 ) {
				arrayOfStrokes.push(
					{
						"color": stroke_color,
						"stroke": stroke
					}
				);
			}
			stroke = [];
			break;
		case MODE_SELECT :
		for ( var l = 0; l < arrayOfStrokes.length; ++l ){
				arrayOfStrokes[l].color = stroke_color;
			}
			redraw();
			
		for ( var j = 0; j < arrayOfStrokes.length; ++j ){
		var ct = 0;		
		
			for ( var l = 0; l < arrayOfStrokes[j].stroke.length; ++l ) {
						var x1 = arrayOfStrokes[j].stroke[l].x;
						var y1 = arrayOfStrokes[j].stroke[l].y;
						//to check if the point is inside the rectangle
						if ((x1 >= startX && x1 <= (startX + width) && y1 >= startY && y1 <= (height + startY))||
						   (x1 >= startX && x1 <= (startX + width) && y1 <= startY && y1 >= (height + startY))|| 
						   (x1 <= startX && x1 >= (startX + width) && y1 <= startY && y1 >= (height + startY))||
						   (x1 <= startX && x1 >= (startX + width) && y1 >= startY && y1 <= (height + startY))
						   )
						{
							ct++;
						}

						if (ct ==arrayOfStrokes[j].stroke.length){
							/*drawStroke({
								"color": "#ff8000",
								"stroke": arrayOfStrokes[j].stroke
							});*/

								arrayOfStrokes[j].color = "#ff8000";
								redraw();
						}
					}
				}

				
			break;
		case MODE_MOVE :

			break;
	}
	mouse_previous_x = event_x;
	mouse_previous_y = event_y;
}

function mouseMoveHandler(e) {
	var canvas_rectangle = canvas.getBoundingClientRect();
	var event_x = e.clientX - canvas_rectangle.left;
	var event_y = e.clientY - canvas_rectangle.top;
	//console.log("mouse move");
	switch ( mode ) {
		case MODE_DRAW :
			if ( buttonIsDown ) {
				stroke.push( { x : event_x, y : event_y } );
			}
			redraw();
			break;
		case MODE_SELECT :
			if (buttonIsDown) {
				redraw();
				canvas_context.beginPath();
				canvas_context.fillStyle = "#ff8000";
				 width = event_x - startX;
    			 height = event_y - startY;
				canvas_context.rect(startX, startY, width, height);
				canvas_context.fill();
				canvas_context.closePath();
			}
			break;
		case MODE_MOVE :
			disX = event_x - mouse_drag_start_x;
			disY = event_y - mouse_drag_start_y;
			mouse_drag_start_x = event_x;
			mouse_drag_start_y = event_y;
			if(buttonIsDown){
				for(var s = 0; s < arrayOfStrokes.length; ++s ){
					if(arrayOfStrokes[s].color == "#ff8000"){
						for(var c = 0; c < arrayOfStrokes[s].stroke.length ; ++c){
							arrayOfStrokes[s].stroke[c].x += disX;
							arrayOfStrokes[s].stroke[c].y +=  disY;
						}
					}
					redraw();
				}
			}
			break;
	}
	mouse_previous_x = event_x;
	mouse_previous_y = event_y;
}

canvas.addEventListener('mousedown',mouseDownHandler);
canvas.addEventListener('mouseup',mouseUpHandler);
canvas.addEventListener('mousemove',mouseMoveHandler);

function drawStroke( stroke_object ) {

	//Get the stroke from the object
	var s = stroke_object.stroke;

	canvas_context.beginPath();
	for ( var i = 0; i < s.length; ++i ) {
		var x = s[i].x;
		var y = s[i].y;
		if ( i === 0 ) {
			canvas_context.moveTo(x,y);
		}
		else {
			canvas_context.lineTo(x,y);
		}
	}
	canvas_context.strokeStyle = stroke_object.color;
	canvas_context.stroke();
}

var redraw = function() {
	canvas_context.clearRect(0, 0, canvas.width, canvas.height);

	for ( var i = 0; i < arrayOfStrokes.length; ++i ) {
		drawStroke( arrayOfStrokes[i] );
	}

	if ( buttonIsDown ) {
		//Draw a temporary stroke with mouse button is down
		drawStroke(
			{
				"color": "#ff8000",
				"stroke": stroke
			}
		);
	}
}

redraw();

var setMode = function( m ) {
	mode = m;
	//console.log("The current mode is " + mode );
}

function clearButtonHandler() {
	arrayOfStrokes = [];
	redraw();
}



</script>

<script type="module">

	//Source du menu radial: https://github.com/victorqribeiro/radialMenu
/*
	const radial = new RadialMenu({
      buttons: [

        {'text': '\uF040 \r ', 'action': () => {
			//alert("Dessiner");
			setMode(MODE_DRAW);
			document.getElementById("radio_draw").checked = true;
		} },

        {'text': '\uF096', 'action': () => {
			//alert("Sélectionner");
			setMode(MODE_SELECT);
			document.getElementById("radio_select").checked = true;
		} },

        {'text': '\uF255', 'action': () => {
			//alert("Déplacer");
			setMode(MODE_MOVE);
			document.getElementById("radio_move").checked = true;
		} },

		{'text': '\uF014', 'action': () => {
			//alert("Tout effacer");
			clearButtonHandler();
		} }

      ],
	  innerCircle: 30,
	  fontSize: 20,
	  hoverBackgroundColor: "#afcb38",
	  shadowBlur: 4,
	  shadowColor: "rgba(0,0,0,0.6)",
	  shadowOffsetX: 5,
	  shadowOffsetY: 5
	});*/
</script>

</body>
</html>
